<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OCR Accuracy Arena</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <h1>ระบบประเมินความแม่นยำ OCR</h1>
        <p>
          อัปโหลดภาพพร้อมกรอกค่าที่อยู่ในกรอบ Label (Production, Time, Expiry, Code)
          ระบบจะตรวจว่าข้อความจาก OCR ตรงกับ Label หรือไม่
        </p>
      </header>

      {% if error %}
      <div class="alert">{{ error }}</div>
      {% endif %}

      <form class="form" id="ocr-form" method="post" enctype="multipart/form-data">
        <div class="form-header">
          <h2>รายการรูปภาพ</h2>
          <button class="secondary" type="button" id="add-entry">เพิ่มรูปภาพ</button>
        </div>

        <div id="entries">
          {% if entries %}
            {% for entry in entries %}
              <div class="entry-card" data-index="{{ entry.index }}">
                <div class="entry-header">
                  <strong>รูปที่ {{ loop.index }}</strong>
                </div>
                <label class="file-upload">
                  <span>เลือกรูปภาพ</span>
                  <input type="file" name="image_{{ entry.index }}" accept="image/*" />
                </label>
                <div class="image-preview">
                  {% if entry.image_url %}
                    <img src="{{ entry.image_url }}" alt="ภาพที่อัปโหลด {{ entry.filename }}" />
                  {% else %}
                    <span class="muted">ยังไม่ได้อัปโหลดรูปภาพ</span>
                  {% endif %}
                </div>
                <div class="grid">
                  <label>
                    Production
                    <input name="production_{{ entry.index }}" type="text" value="{{ entry.labels.Production }}" />
                  </label>
                  <label>
                    Time
                    <input name="time_{{ entry.index }}" type="text" value="{{ entry.labels.Time }}" />
                  </label>
                  <label>
                    Expiry
                    <input name="expiry_{{ entry.index }}" type="text" value="{{ entry.labels.Expiry }}" />
                  </label>
                  <label>
                    Code
                    <input name="code_{{ entry.index }}" type="text" value="{{ entry.labels.Code }}" />
                  </label>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="entry-card" data-index="0">
              <div class="entry-header">
                <strong>รูปที่ 1</strong>
              </div>
              <label class="file-upload">
                <span>เลือกรูปภาพ</span>
                <input type="file" name="image_0" accept="image/*" required />
              </label>
              <div class="image-preview">
                <span class="muted">ยังไม่ได้อัปโหลดรูปภาพ</span>
              </div>
              <div class="grid">
                <label>
                  Production
                  <input name="production_0" type="text" placeholder="เช่น 2024-06-01" />
                </label>
                <label>
                  Time
                  <input name="time_0" type="text" placeholder="เช่น 14:30" />
                </label>
                <label>
                  Expiry
                  <input name="expiry_0" type="text" placeholder="เช่น 2025-06-01" />
                </label>
                <label>
                  Code
                  <input name="code_0" type="text" placeholder="เช่น ABC12345" />
                </label>
              </div>
            </div>
          {% endif %}
        </div>

        <button class="primary" type="submit">ประเมินผล</button>
      </form>

      <section class="progress-panel" id="progress-panel" hidden>
        <h2>กำลังประมวลผล</h2>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progress-bar-fill"></div>
        </div>
        <div class="progress-meta">
          <span id="progress-percent">0%</span>
          <span id="progress-status" class="muted">รอเริ่มต้น</span>
        </div>
        <div class="progress-log">
          <pre id="progress-log">ยังไม่มี log</pre>
        </div>
      </section>

      <div id="results-container">
        {% include "results.html" %}
      </div>
    </main>

    <template id="entry-template">
      <div class="entry-card" data-index="__index__">
        <div class="entry-header">
          <strong>รูปที่ __number__</strong>
        </div>
        <label class="file-upload">
          <span>เลือกรูปภาพ</span>
          <input type="file" name="image___index__" accept="image/*" required />
        </label>
        <div class="image-preview">
          <span class="muted">ยังไม่ได้อัปโหลดรูปภาพ</span>
        </div>
        <div class="grid">
          <label>
            Production
            <input name="production___index__" type="text" placeholder="เช่น 2024-06-01" />
          </label>
          <label>
            Time
            <input name="time___index__" type="text" placeholder="เช่น 14:30" />
          </label>
          <label>
            Expiry
            <input name="expiry___index__" type="text" placeholder="เช่น 2025-06-01" />
          </label>
          <label>
            Code
            <input name="code___index__" type="text" placeholder="เช่น ABC12345" />
          </label>
        </div>
      </div>
    </template>

    <script>
      const form = document.getElementById("ocr-form");
      const addButton = document.getElementById("add-entry");
      const entries = document.getElementById("entries");
      const template = document.getElementById("entry-template").innerHTML.trim();
      const progressPanel = document.getElementById("progress-panel");
      const progressBarFill = document.getElementById("progress-bar-fill");
      const progressPercent = document.getElementById("progress-percent");
      const progressStatus = document.getElementById("progress-status");
      const progressLog = document.getElementById("progress-log");
      const resultsContainer = document.getElementById("results-container");

      function attachPreview(card) {
        const input = card.querySelector("input[type='file']");
        const preview = card.querySelector(".image-preview");
        if (!input || !preview) {
          return;
        }
        input.addEventListener("change", () => {
          if (!input.files || !input.files[0]) {
            preview.innerHTML = '<span class="muted">ยังไม่ได้อัปโหลดรูปภาพ</span>';
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            const src = event.target?.result;
            if (typeof src === "string") {
              preview.innerHTML = `<img src="${src}" alt="ภาพที่เลือก" />`;
            }
          };
          reader.readAsDataURL(input.files[0]);
        });
      }

      function nextIndex() {
        const cards = entries.querySelectorAll(".entry-card");
        return cards.length ? cards.length : 0;
      }

      addButton.addEventListener("click", () => {
        const index = nextIndex();
        const number = index + 1;
        const html = template
          .replaceAll("__index__", index)
          .replaceAll("__number__", number);
        const wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        const card = wrapper.firstElementChild;
        entries.appendChild(card);
        attachPreview(card);
      });

      entries.querySelectorAll(".entry-card").forEach(attachPreview);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        progressPanel.hidden = false;
        progressBarFill.style.width = "0%";
        progressPercent.textContent = "0%";
        progressStatus.textContent = "เริ่มประมวลผล";
        progressLog.textContent = "";
        resultsContainer.innerHTML = "";

        const submitButton = form.querySelector("button[type='submit']");
        if (submitButton) {
          submitButton.disabled = true;
        }

        const response = await fetch("/start", {
          method: "POST",
          body: new FormData(form),
        });

        const payload = await response.json();
        if (!response.ok) {
          progressStatus.textContent = payload.error || "เกิดข้อผิดพลาด";
          if (submitButton) {
            submitButton.disabled = false;
          }
          return;
        }

        const eventSource = new EventSource(`/progress/${payload.job_id}`);
        eventSource.onmessage = async (message) => {
          const data = JSON.parse(message.data);
          if (data.logs && data.logs.length) {
            const current = progressLog.textContent ? `${progressLog.textContent}\n` : "";
            progressLog.textContent = `${current}${data.logs.join("\n")}`.trim();
          }
          if (typeof data.progress === "number") {
            progressBarFill.style.width = `${data.progress}%`;
            progressPercent.textContent = `${data.progress}%`;
          }
          if (data.error) {
            progressStatus.textContent = data.error;
          } else if (data.done) {
            progressStatus.textContent = "เสร็จสิ้น";
          }

          if (data.done) {
            eventSource.close();
            const resultsResponse = await fetch(`/results/${payload.job_id}`);
            const resultsPayload = await resultsResponse.json();
            if (resultsPayload.html) {
              resultsContainer.innerHTML = resultsPayload.html;
            }
            if (submitButton) {
              submitButton.disabled = false;
            }
          }
        };
      });
    </script>
  </body>
</html>
